name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{steps.set-matrix.outputs.matrix}}
    steps:
      - id: set-matrix
        run: |
          if [ "${{github.event_name}}" == "pull_request" ]; then
            # For PRs, only include Linux targets
            echo 'matrix={"include":[{"target":"x86_64-unknown-linux-musl","os":"ubuntu-latest"},{"target":"aarch64-unknown-linux-musl","os":"ubuntu-latest"},{"target":"i686-unknown-linux-musl","os":"ubuntu-latest"}]}' >> $GITHUB_OUTPUT
          else
            # For pushes to main, include all targets
            echo 'matrix={"include":[{"target":"x86_64-unknown-linux-musl","os":"ubuntu-latest"},{"target":"aarch64-unknown-linux-musl","os":"ubuntu-latest"},{"target":"i686-unknown-linux-musl","os":"ubuntu-latest"},{"target":"aarch64-apple-darwin","os":"macos-latest"}]}' >> $GITHUB_OUTPUT
          fi

  build:
    needs: matrix

    strategy:
      matrix: ${{fromJson(needs.matrix.outputs.matrix)}}

    name: 'Building ${{matrix.target}}'
    runs-on: ${{matrix.os}}

    steps:
      - name: Checkout the repo
        uses: actions/checkout@v4

      - uses: ./.github/actions/build
        id: build
        with:
          target: ${{matrix.target}}
          profile: release-lto-nodebug

      - name: "Build ${{steps.build.outputs.version}}"
        run: |
          # The binary was already built in the previous step but we must have a step
          # named exactly "Build <version>" to allow the Cloudflare workers to detect
          # the version of the commit.

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yarn-${{matrix.target}}
          path: |
            target/${{matrix.target}}/release-lto-nodebug/yarn-bin
            target/${{matrix.target}}/release-lto-nodebug/yarn
            target/${{matrix.target}}/release-lto-nodebug/LICENSE.md
