name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
          - target: i686-unknown-linux-musl
            os: ubuntu-latest
          - target: aarch64-apple-darwin
            os: macos-latest

    name: "Building ${{matrix.target}}"
    runs-on: ${{matrix.os}}

    steps:
      - name: Checkout the repo
        uses: actions/checkout@v4

      - uses: ./.github/actions/build
        id: build
        with:
          target: ${{matrix.target}}
          profile: release-lto-nodebug

      - name: "Build ${{steps.build.outputs.version}}"
        run: |
          # The binary was already built in the previous step but we must have a step
          # named exactly "Build <version>" to allow the Cloudflare workers to detect
          # the version of the commit.

      - name: "Generate an iso image for v86"
        if: matrix.target == 'i686-unknown-linux-musl'
        run: |
          apt-get install libarchive-tools
          cd target/${{matrix.target}}/release-lto-nodebug/
          bsdtar -c -f yarn.iso {yarn,yarn-bin}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yarn-${{matrix.target}}
          path: |
            target/${{matrix.target}}/release-lto-nodebug/yarn-bin
            target/${{matrix.target}}/release-lto-nodebug/yarn
            target/${{matrix.target}}/release-lto-nodebug/LICENSE.md

      - name: Upload iso image
        if: matrix.target == 'i686-unknown-linux-musl'
        uses: actions/upload-artifact@v4
        with:
          name: yarn-${{matrix.target}}-iso
          path: target/${{matrix.target}}/release-lto-nodebug/yarn.iso
